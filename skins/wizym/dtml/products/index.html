<div class="main-shop-right grid">
    <div class="container">
        <div class="d-lg-flex  price-filter clearfix">
            <div class="elm-btn text-center mb-3" id="filter">
                <a class="themesflat-button outline ol-accent margin-top-40 hvr-shutter-out-horizontal">Mostra
                    Filtri</a>
            </div>
            <div class="barra sidebar">
                <div class="sidebar-inner">
                    <div class="widget widget-search">
                        <form action="#" id="searchform" method="get">
                            <div>
                                <input type="text" id="s" class="sss" placeholder="Cerca ...">
                                <button><i class="fa fa-search" aria-hidden="true"></i></button>
                            </div>
                        </form>
                    </div> <!-- /widget-search-->
                    <div class="widget widget-filter">
                        <h2 class="widget-title text-center">Per prezzo</h2>
                        <div class="price-filter clearfix">
                            <label for="customRange2" class="form-label">Prezzo fino a:&nbsp;</label>
                            <output></output>
                            <input type="range" class="form-range custom-range" value="0" min="0" max="1000" step="0.5"
                                   id="customRange2"
                                   oninput="this.previousElementSibling.value = ' ' + this.value + '&euro;'">

                            <span class="filter" id="filtro-prezzo-btn"><a href="#" class="hvr-shutter-out-horizontal">FILTRA</a></span>
                        </div>
                    </div> <!-- /widget-filter-->
                    <div class="widget widget-categories">
                        <h2 class="widget-title text-center mb-1">Categorie</h2>
                        <ul>
                            <li class="thumb-new-categories categorie m-0" style="cursor: pointer">
                                <a id="all">Tutti</a>
                                <img src="skins/wizym/image/dot.jpg" class="m-0" alt="image">
                            </li>
                            <[foreach]>
                            <li class="thumb-new-categories categorie m-0" style="cursor: pointer">
                                <a id="<[categoria_name]>"><[categoria_name]>
                                    <span class="categories-time"><[counter]></span>
                                </a>
                                <img src="skins/wizym/image/dot.jpg" class="m-0" alt="image">
                            </li>
                            <[/foreach]>
                        </ul>
                    </div> <!-- /widget-categories-->
                </div> <!-- /sidebar-inner -->
            </div> <!-- /sidebar -->
            <div class="prodotti">
                <div class="dropdown" style="height: 46px">
                    <button class="btn dropdown-toggle ordina-per" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 100%; width: 30%">
                        Ordina per:
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu2" style="width: 30%">
                        <li class="dropdown-item" id="ordina-prezzo-cres">Prezzo Crescente</li>
                        <li class="dropdown-item" id="ordina-prezzo-decr">Prezzo Decrescente</li>
                        <li class="dropdown-item" id="ordina-nome-az">Nome A-Z</li>
                        <li class="dropdown-item" id="ordina-nome-za">Nome Z-A</li>
                    </ul>
                </div>
                <div class="product-content clearfix shop-right-grid flex flex-wrap justify-content-start">
                    <ul class="product style2 isotope-product clearfix">
                        <[foreach]>
                        <li class="product-item arrivals sale">
                            <input type="hidden" name="product_id<[id]>" value="<[id]>">
                            <input type="hidden" name="categoria" value="<[categoria]>">
                            <input type="hidden" name="produttore" value="<[produttore]>">
                            <input type="hidden" name="percentuale<[id]>" value="<[percentuale]>">
                            <div class="product-thumb clearfix">
                                <a href="/products/<[id]>" class="product-thumb">
                                    <img style="width: 150px; height: auto" src="<[image]>" alt="image">
                                </a>
                            </div>
                            <div class="product-info clearfix">
                                <span class="product-title"><[nome]></span>
                                <div class="price">
                                    <ins>
                                        <span class="amount<[id]>"><[prezzo]>&euro;</span>
                                    </ins>
                                </div>
                            </div>
                            <[percentuale]>
                            <div class="product-review">
                                <[like]>
                                <div class="add-cart">
                                    <a class="like3"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
                                </div>
                            </div>

                        </li> <!-- /product-item -->

                        <[/foreach]>
                    </ul>
                </div>
                <div class="blog-pagination text-center">
                    <ul class="flat-pagination">
                    </ul>
                </div>
            </div>
        </div> <!-- /row -->
    </div> <!-- /container -->
</div> <!-- /main-shop-fullwidth -->


<style>
    .ordina-per, .ordina-per:hover, .ordina-per:focus {
        width: 30%;
        outline: none !important;
    }

    .custom-range::-webkit-slider-thumb {
        background: #c21a1a;
    !important;
    }

    .custom-range::-moz-range-thumb {
        background: #c21a1a;
    !important;
    }

    .custom-range::-ms-thumb {
        background: #c21a1a;
    !important;
    }

    .prodotti {
        width: 73%;
    !important;
    }

    .barra {
        width: 27%;
    !important;
        padding-right: 3rem;
    }

    #filter {
        display: none;
    }

    .sconto {
        position: absolute;
        color: white;
        top: 2rem;
        left: 2rem;
        display: inline-block;
        padding: 10px 15px;
        background-color: #c02323;
        border-radius: 50%;
        margin-bottom: 18px;
    }

    @media (max-width: 991px) {
        .prodotti, .barra {
            width: 100%;
        !important;
            padding-right: 0;
        }

        .barra {
            display: none;
        }

        #filter {
            display: block;
        }

        .sconto {
            top: 2rem;
            left: 5.5rem;
        }
    }
</style>

<script>
    $(document).ready(function () {
        const allItems = $('.product-item'); //tutti i prodotti

        paginate(allItems); //prima chiamata alla paginazione

        $.each($('span[id^="percentuale"]'), function () {
            let id = $(this).attr('id').replace('percentuale', '');
            let percentuale = parseInt($(this).text().slice(1, -1));
            if (!isNaN(percentuale)) {
                let amount = $('.amount' + id);
                let prezzo_base = amount.text().slice(0, -1);
                let prezzo_scontato = prezzo_base - (prezzo_base * (percentuale / 100));

                amount.html(`<p>${prezzo_scontato.toFixed(2)} € &nbsp;</p>`);
                amount.after(`<p style="color: black; font-size: .7em;">Prezzo consigliato: <s>${parseFloat(prezzo_base).toFixed(2)}€</s></p>`);
            }
        });

        // Comparsa dei filtri su mobile
        $('#filter').on('click', function () {
            $('.sidebar').slideToggle();
        });

        //filtro categorie
        $('li.thumb-new-categories').click(function () {
            let categoria = $(this).find('a').attr('id');
            if (categoria === 'all') {
                location.reload();
            } else {
                let items = allItems.find("input[value='" + categoria + "']").parent();
                paginate(items, true);
            }
        });

        //filtro prezzo
        $('#filtro-prezzo-btn').click(function () {
            let value = $('input[type="range"]').val();
            let items = allItems.find('span[class^="amount"]').filter(function () {
                return parseFloat($(this).text().replace('€', '')) <= value;
            }).parent().parent().parent().parent();
            paginate(items, true);
            $('#da_attivare').trigger('click');
        });

        //filtro titolo
        $('#s').keyup(function () {
            if ($(this).val().length >= 3) {
                let value = $(this).val();
                let items = allItems.find('span[class^="product-title"]').filter(function () {
                    return $(this).text().toLowerCase().includes(value.toLowerCase());
                }).parent().parent();
                paginate(items, true);
            } else {
                paginate(allItems, true);
            }
            $('#da_attivare').trigger('click');
        });

        // Paginazione
        function paginate(items, filter = false) {
            let numItems = items.length;
            let perPage = 9;
            let pages = Math.ceil(numItems / perPage) + 1;
            let currentPage = 0;
            $('.product').css('height', 'auto');
            $('.flat-pagination').empty();
            if (filter) {
                $('.product').empty();
                $.each(items, function () {
                    $(this).show();
                    $(this).css({'position': 'relative', 'top': '0', 'left': '0'});
                    $('.product').append($(this));
                });
            } else {
                items.slice(perPage).hide();
            }

            for (let i = 1; i < pages; i++) {
                if (i === 1) {
                    $('.flat-pagination').append('<li class="active"><a href="#" id="da_attivare" class=" hvr-shutter-out-horizontal">' + i + '</a></li>');
                } else {
                    $('.flat-pagination').append('<li><a href="#" class=" hvr-shutter-out-horizontal">' + i + '</a></li>');
                }
            }

            $('.flat-pagination li').on('click', function () {
                let $this = $(this);
                $('li').removeClass('active');
                $this.addClass('active');
                currentPage = $this.index();
                let startItem = currentPage * perPage;
                let endItem = startItem + perPage;
                items.hide().slice(startItem, endItem).show().css({'position': 'relative', 'top': '', 'left': ''});
            });
        }

        // Ordinamento in base al prezzo
        $('#ordina-prezzo-cres').click(function () {
            let items = allItems.sort(function (a, b) {
                return parseFloat($(a).find('span[class^="amount"]').text().replace('€', '')) - parseFloat($(b).find('span[class^="amount"]').text().replace('€', ''));
            });
            paginate(items, true);
            $('#da_attivare').trigger('click');
        });

        $('#ordina-prezzo-decr').click(function () {
            let items = allItems.sort(function (a, b) {
                return parseFloat($(b).find('span[class^="amount"]').text().replace('€', '')) - parseFloat($(a).find('span[class^="amount"]').text().replace('€', ''));
            });
            paginate(items, true);
            $('#da_attivare').trigger('click');
        });

        // Ordinamento in base al titolo
        $('#ordina-nome-az').click(function () {
            let items = allItems.sort(function (a, b) {
                return $(a).find('span[class^="product-title"]').text().localeCompare($(b).find('span[class^="product-title"]').text());
            });
            paginate(items, true);
            $('#da_attivare').trigger('click');
        });

        $('#ordina-nome-za').click(function () {
            let items = allItems.sort(function (a, b) {
                return $(b).find('span[class^="product-title"]').text().localeCompare($(a).find('span[class^="product-title"]').text());
            });
            paginate(items, true);
            $('#da_attivare').trigger('click');
        });
    });


</script>